---
layout: post
title: Metabase - BI on ERPnext
image:
  path: /assets/img/blog/Metabase/cube_1920.jpg
  srcset:
    1920w: /assets/img/blog/Metabase/cube_1920.jpg
    960w:  /assets/img/blog/Metabase/cube_1280.jpg
    480w:  /assets/img/blog/Metabase/cube_640.jpg
description: >
  Install metabase and connect to ERPNext to analyze data
grouped: true
---

Hey there! It has been a while since my last post. I have been helping my friends at [rezemo](https://rezemo.de/) to set up their IT on a bare metal server. They run an ERPNext as their ERP system, see my blog post [here]({% link _posts/2022-01-02-FossErp.md %}). Now they want to analyze their data to make better decisions. They chose Metabase as their BI software. [Metabase](https://www.metabase.com/) is an easy to use dashboarding tool that can be hosted anywhere, connects to the most common databases and has s a free license available that comes with the most important features to get started. You can choose to pay for a [hosted version](https://www.metabase.com/pricing/). Below I explore how to install it on a Linux VM. 



# Prerequisites

You will need an Ubuntu VM >=18.04 with at least 1GB and 1 vCPU ([Source](https://discourse.metabase.com/t/what-are-metabase-minimum-resources/21470)). I would recommend to start with twice the size and if you expect a lot of concurrent access scale it accordingly. You can always adjust the allocated RAM in your hypervisor later. You will also need:
- a priviledged user
- internet access in the VM


# Installation
The installation follows the official Metabase documentation for a productive setup: [Link](https://www.metabase.com/docs/latest/installation-and-operation/running-metabase-on-docker#production-installation). I will run Metabase in docker using docker compose. Metabase needs a database to store internal information like dashboards, users etc. I will use postgres as its database and run it on the same host. Note that you might want to run postgres on a different host for increased resilience. Depending on how critical the availability of Metabase is to you, you might also want to run Metabase and its underlying database in a high availability setup. This would require you to set up a proxy and one or two additional hosts as well as a sync for the internal database. The following is a minimal installation without high availability.

## Installing docker engine and docker compose

1. Uninstall docker on your VM
	```sh
	sudo apt-get purge docker-ce docker-ce-cli containerd.io docker-compose-plugin
	sudo rm -rf /var/lib/docker && sudo rm -rf /var/lib/containerd
	```

2. Install docker following [Link](https://docs.docker.com/engine/install/ubuntu/) repository method:
    
    1. Update and install dependencies
 
	 ```sh  
	sudo apt-get update
	sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
	```
    2. Download the GPG key to verify validity of the install packages

	```sh
	sudo mkdir -p /etc/apt/keyrings
	curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
	```

	3. Add the repository

	```sh
	echo \
	"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg]
	https://download.docker.com/linux/ubuntu \
	  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
	```
	
    4. Install docker

	 ```sh  
	sudo apt-get update
	sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
	```
	5. Verify that docker is running

	```sh
	sudo docker run hello-world
	```

3. Create a docker-compose file e.g. in your home directory

```
vi /home/docker-compose.yml
```

Add the following to the docker-compose file:
```yaml
services:

  postgres-db:
    image: postgres:15
    restart: always
    # ports:
    #   - 5432:5432
    env_file: .db.env
    volumes:
      # declare your mount volume /host/dir:/container/dir
      - /home/app/metadata:/var/lib/postgresql/data
    networks:
      - metabase-network

  metabase-app:
    image: metabase/metabase
    restart: always
    ports:
      - 3000:3000
    env_file: .metabase.env
    depends_on:
      - postgres-db
    networks:
      - metabase-network

networks:
  metabase-network:
    driver: bridge

```

It is important to define a persistent volume for the postgres, this is where the internal data of Metabase will be stored on your host. you can backup or sync this directory e.g. via rsync.


4. create .env files

```sh
vi .db.env
vi .metabase.env
```

5. Create a shell script that loads your compose file on start of the VM. Instead of ```cd``` to the directory you could also specify the file in the docker compose command.
```sh
sudo vi /home/admin_metabase/Rezemo/Metabase/startup_mb.sh
sudo chmod +x /home/admin_metabase/Rezemo/Metabase/startup_mb.sh
```
	Add:
	#!/bin/bash
	cd /home/startup_mb.sh
	docker compose up -d


6. Configure autostart of docker-compose on VM start:
```sh
sudo crontab -e
```
	Add:
	@reboot /home/admin/metabase/Rezemo/Metabase/startup_mb.sh


With this you should have a running Metabase on \<ip-of-your-VM>:3000
